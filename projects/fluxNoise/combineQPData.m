% Plot_QP_Tunneling('Circ1\', 'Q2\', '07-21-19\', 21, 51);
% Plot_QP_Tunneling('Circ1\', 'Q3\', '07-26-19\', 0, 210);
% Plot_QP_Tunneling('Circ1\', 'Q4\', '07-21-19\', 2, 38);
% Plot_QP_Tunneling('Circ2\', 'Q1\', '07-26-19\', 0, 70);
% Plot_QP_Tunneling('Circ2\', 'Q3\', '07-25-19\', 0, 691);
% Plot_QP_Tunneling('Circ2\', 'Q4\', '07-19-19\', 0, 30);

% Plot_QP_Tunneling('Circ1\', 'Q1\', '08-22-19\', 0, 218);
% Plot_QP_Tunneling('Circ1\', 'Q1\', '08-29-19\', 0, 99);
% Plot_QP_Tunneling('Circ1\', 'Q2\', '08-22-19\', 0, 118);
% Plot_QP_Tunneling('Circ1\', 'Q3\', '08-21-19\', 0, 88);
% Plot_QP_Tunneling('Circ1\', 'Q4\', '08-22-19\', 0, 204);
% Plot_QP_Tunneling('Circ1\', 'Q4\', '08-29-19\', 0, 99);
% Plot_QP_Tunneling('Circ2\', 'Q1\', '08-26-19\', 0, 1113);
% Plot_QP_Tunneling('Circ2\', 'Q3\', '08-26-19\', 0, 2536);
% Plot_QP_Tunneling('Circ2\', 'Q3\', '08-26-19\', 2537, 2619);
% Plot_QP_Tunneling('Circ2\', 'Q3\', '09-06-19\', 0, 499);
% Plot_QP_Tunneling('Circ2\', 'Q3\', '09-06-19\', 500, 793);
% Plot_QP_Tunneling('Circ2\', 'Q4\', '08-26-19\', 0, 99);
% Plot_QP_Tunneling('Circ1\', 'Q2\', '08-30-19\', 0, 1242);
% Plot_QP_Tunneling('Circ2\', 'Q4\', '09-06-19\', 0, 734);
% Plot_QP_Tunneling('Circ2\', 'Q4\', '09-07-19\', 0, 264);
% Plot_QP_Tunneling('Circ1\', 'Q3\', '09-16-19\', 0, 263);

% Plot_QP_Tunneling('Circ2\', 'Q3\', '09-29-19\', 0, 438);
% Plot_QP_Tunneling('Circ1\', 'Q2\', '09-30-19\', 0, 749);
% Plot_QP_Tunneling('Circ1\', 'Q3\', '09-30-19\', 0, 710);
% Plot_QP_Tunneling('Circ2\', 'Q1\', '09-30-19\', 0, 749);
% Plot_QP_Tunneling('Circ2\', 'Q4\', '09-30-19\', 0, 749);
% Plot_QP_Tunneling('Circ2\', 'Q1\', '10-08-19\', 0, 84);
% Plot_QP_Tunneling('Circ2\', 'Q1\', '10-08-19\', 85, 581);
% Plot_QP_Tunneling('Circ1\', 'Q2\', '10-10-19\', 0, 999);
% Plot_QP_Tunneling('Circ1\', 'Q3\', '10-10-19\', 0, 999);

% Plot_QP_Tunneling('DR1 - 2019-11-12\', 'AlQPAntenna\', 'Q1\', '11-19-19\', 0, 806);
% Plot_QP_Tunneling('DR1 - 2019-11-12\', 'AlQPAntenna\', 'Q2\', '11-20-19\', 0, 999);
% Plot_QP_Tunneling('DR1 - 2019-11-12\', 'AlQPAntenna\', 'Q3\', '11-20-19\', 0, 999);
% Plot_QP_Tunneling('NbQPAntenna\', 'Q1\', '11-22-19\', 0, 999);
% Plot_QP_Tunneling('NbQPAntenna\', 'Q3\', '11-22-19\', 0, 999);
% Plot_QP_Tunneling('NbQPAntenna\', 'Q1\', '11-22-19\', 1000, 1741);
% Plot_QP_Tunneling('NbQPAntenna\', 'Q3\', '11-23-19\', 0, 999);
% Plot_QP_Tunneling('NbQPAntenna\', 'Q1\', '11-23-19\', 258, 1257);
% Plot_QP_Tunneling('NbQPAntenna\', 'Q3\', '11-23-19\', 1000, 1774);
% Plot_QP_Tunneling('NbQPAntenna\', 'Q1\', '11-24-19\', 0, 999); % big tail
% Plot_QP_Tunneling('NbQPAntenna\', 'Q3\', '11-24-19\', 0, 999);
% Plot_QP_Tunneling('CorrFar\', 'Q3\', '11-26-19\', 0, 999);
% Plot_QP_Tunneling('CorrFar\', 'Q4\', '11-26-19\', 0, 999);
% Plot_QP_Tunneling('CorrFar\', 'Q4\', '11-26-19\', 1000, 1499);%40ns
% Plot_QP_Tunneling('CorrFar\', 'Q4\', '11-26-19\', 1450, 1858);%300ns idle

% Plot_QP_Tunneling('DR1 - 2019-11-12\', 'NbQPAntenna\', 'Q1\', '12-11-19\', 0, 999);

% Plot_QP_Tunneling('DR1 - 2019-12-17\', 'AlQPAntenna\', 'Q3\', '12-20-19\', 0, 499);
% Plot_QP_Tunneling('DR1 - 2019-12-17\', 'AlQPAntenna\', 'Q2\', '12-20-19\', 0, 499);
% Plot_QP_Tunneling('DR1 - 2019-12-17\', 'AlQPAntenna\', 'Q1\', '12-20-19\', 0, 999);
% Plot_QP_Tunneling('DR1 - 2019-12-17\', 'AlQPAntenna\', 'Q2\', '12-21-19\', 0, 638);
% Plot_QP_Tunneling('DR1 - 2019-12-17\', 'AlQPAntenna\', 'Q3\', '12-21-19\', 0, 999);
Plot_QP_Tunneling('DR1 - 2019-12-17\', 'AlQPAntenna\', 'Q3\', '12-21-19\', 0, 199);
Plot_QP_Tunneling('DR1 - 2019-12-17\', 'AlQPAntenna\', 'Q3\', '12-21-19\', 0, 499);

% plotFit(1/0.28e-3, 2e-5);
% plotFit(1/13e-3, 9e-4);
% plotFit(1/1e-3, 5e-5);
% plotFit(1/1.5e-3, 4e-4);

function [] = plotFit(gamma, A0)
    f = 10.^[-1:0.01:3.5]; 
    A = gamma/4*A0;
    theoryplot = gamma*A./(4*pi^2*f.^2+gamma^2/4);
    figure(111); hold on; 
    plot(f,theoryplot, 'DisplayName', ['fit ',num2str(1e3/gamma),'ms'])
end

function [window_avg_psd, psd_freq] = Plot_QP_Tunneling(CDdate, samples, ...
                                    qubit, date, minFileIndex, maxFileIndex)

    %PARAMETERS
    reps = 8192;
    trials = 5;
    refreshTime = 100e-6;
%     CDdate = 'DR1 - 2019-11-12\';

    dataType = 'QP_Tunneling_PSD';
    ext = strcat(['Z:\mcdermott-group\data\fluxNoise\',CDdate,samples, ...
              qubit,'General\',date,dataType,'\MATLABData\',dataType,'_']);

    Fs = 1/refreshTime;%samples per second
    N = reps * trials;
    vis = 1;
    transfer = 1/vis^2;%1.485e-5/0.0002957;
    
    % load the data into the needed matrix
%     data = zeros(maxFileIndex-minFileIndex, N);
    data = zeros(5*(maxFileIndex-minFileIndex), reps);
    for i = minFileIndex:maxFileIndex
        ldata = load(strcat([ext,num2str(i,'%03d'),'.mat']));
%         data(i-minFileIndex+1,:) = reshape(eval(strcat( ...
%             ['ldata.',dataType,'.Data.Single_Shot_Occupations']))',[N,1]);
        data(5*(i-minFileIndex+1)-4:5*(i-minFileIndex+1),:) = ...
            eval(strcat(['ldata.',dataType,'.Data.Single_Shot_Occupations']));
    end
    
    [avg_cpsd, psd_freq] = noiselib.partition_and_avg_psd(data, Fs);
    avg_cpsd = avg_cpsd' * transfer;
    window_avg_psd = noiselib.window_averaging(avg_cpsd);

    %Fit to find QP tunneling rate:
    % x = psd_freq(2:end);
    % y = abs(window_avg_psd(2:end));
    % [x, y] = prepareCurveData(x, y);
    % [fr,~] = noiselib.fit_lorenzian(x,y);

    % f = 0.01:0.01:5e3; gamma = 1056;lor = 3.8e2./(4*pi^2*f.^2+gamma^2);
    % figure(12);hold on;plot(f,lor)

    %Plot
    figure(111);hold on
    title('1/f Averaged PSD')
    plot(psd_freq,abs(window_avg_psd), 'DisplayName', [samples(1:end-1),qubit(1:end-1)])
    % plot(fr, x, y);
    set(gca,'xscale','log')
    set(gca,'yscale','log')
    xlabel('Frequency (Hz)')
    ylabel('S_\eta (\eta^2/Hz)')
    grid on

end